(()=>{var e={};e.id=208,e.ids=[208],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4967:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>p,routeModule:()=>l,serverHooks:()=>h,workAsyncStorage:()=>c,workUnitAsyncStorage:()=>u});var o={};t.r(o),t.d(o,{POST:()=>d});var n=t(6559),s=t(8088),i=t(7719);async function a(e){try{let r=await fetch("https://openapi.youdao.com/q_anything/api/kb_list",{method:"GET",headers:{Authorization:e}});if(r.ok){let e=await r.json();if(0==e.errorCode&&e.result&&e.result.length>0){let r=e.result[0].kbId;return console.log("Using existing knowledge base:",r),r}}console.log("Creating new knowledge base...");let t=await fetch("https://openapi.youdao.com/q_anything/api/create_kb",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({kbName:"Course Showcase AI助手"})});if(!t.ok){let e=await t.text();throw Error(`Failed to create knowledge base: ${t.status} - ${e}`)}let o=await t.json();if(0!=o.errorCode)throw Error(`Knowledge base creation failed: ${o.msg}`);let n=o.result.kbId;return console.log("Created new knowledge base:",n),console.log("Please add FAQs through QAnything platform to enable Q&A functionality."),n}catch(e){throw console.error("Error managing knowledge base:",e),e}}async function d(e){try{let r=await e.json(),t=process.env.QANYTHING_API_KEY;if(!t)return new Response(JSON.stringify({success:!1,error:"QAnything API Key not configured"}),{status:500,headers:{"Content-Type":"application/json"}});if(!r.question||0===r.question.trim().length)return new Response(JSON.stringify({success:!1,error:"问题不能为空"}),{status:400,headers:{"Content-Type":"application/json"}});let o={question:r.question,kbIds:r.kbIds&&r.kbIds.length>0?r.kbIds:[],prompt:r.prompt||"",history:r.history||[],model:r.model||"QAnything 4o mini",maxToken:r.maxToken||1024,hybridSearch:r.hybridSearch||!1,networking:void 0!==r.networking&&r.networking,sourceNeeded:void 0===r.sourceNeeded||r.sourceNeeded},n=new ReadableStream({async start(e){try{let r,n=o.kbIds;n&&0!==n.length||(n=[await a(t)]);let s=n.filter(e=>e&&"string"==typeof e&&e.startsWith("KB"));if(0===s.length)throw Error("无效的知识库ID格式");n=s;let i={question:o.question,kbIds:n,prompt:o.prompt||"",history:o.history||[],model:o.model||"QAnything 4o mini",maxToken:o.maxToken||1024,hybridSearch:o.hybridSearch||!1,networking:void 0!==o.networking&&o.networking,sourceNeeded:void 0===o.sourceNeeded||o.sourceNeeded};console.log("QAnything API Request:",JSON.stringify(i,null,2));let d=0;for(;d<=2;)try{if((r=await fetch("https://openapi.youdao.com/q_anything/api/chat_stream",{method:"POST",headers:{Authorization:t,"Content-Type":"application/json"},body:JSON.stringify(i)})).ok||r.status<500)break;if(d<2)console.log(`QAnything API server error (${r.status}), retrying... (${d+1}/2)`),await new Promise(e=>setTimeout(e,1e3*(d+1))),d++;else break}catch(e){if(console.error("QAnything API fetch error:",e),d<2)console.log(`Network error, retrying... (${d+1}/2)`),await new Promise(e=>setTimeout(e,1e3*(d+1))),d++;else throw e}if(!r)throw Error("Failed to get response from QAnything API after retries");if(!r.ok){let t=`HTTP ${r.status}: ${r.statusText}`;try{let e=await r.text();if(e){console.error("QAnything API Error Response:",e);try{let r=JSON.parse(e);"303"===r.errorCode||303===r.errorCode?t="QAnything服务器暂时不可用，请稍后重试":"406"===r.errorCode||406===r.errorCode?t="QAnything API参数错误，请检查知识库设置":r.msg&&(t=`QAnything API错误：${r.msg}`)}catch{t+=` - ${e}`}}}catch(e){console.error("Failed to read error response:",e)}let o={errorCode:-1,msg:t,result:{question:i.question,response:`抱歉，${t}`,history:i.history||[]}};e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(o)}

`)),e.close();return}let l=r.body?.getReader();if(!l)throw Error("无法读取响应流");let c=new TextDecoder;try{for(;;){let{done:r,value:t}=await l.read();if(r)break;for(let r of c.decode(t,{stream:!0}).split("\n"))if(r.startsWith("event:data"))e.enqueue(new TextEncoder().encode(`event: data
`));else if(r.startsWith("data:"))try{let t=r.slice(5).trim();if(!t){e.enqueue(new TextEncoder().encode(`${r}
`));continue}let o=JSON.parse(t);if(o.errorCode&&0!==o.errorCode){console.error("QAnything API returned error:",o);let r={errorCode:o.errorCode,msg:o.msg||"QAnything API error",requestId:o.requestId||"",result:{question:i.question,response:o.result?.response||`抱歉，${o.msg||"QAnything API出现错误"}`,history:o.result?.history||i.history||[],source:o.result?.source||[]}};e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(r)}

`))}else e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(o)}

`))}catch(t){console.warn("Failed to parse SSE data:",r,t),e.enqueue(new TextEncoder().encode(`${r}
`))}else""===r.trim()&&e.enqueue(new TextEncoder().encode(`
`))}}finally{l.releaseLock()}e.close()}catch(o){console.error("Stream error:",o);let t={errorCode:-1,msg:o instanceof Error?o.message:"Unknown error",result:{question:r.question,response:"抱歉，处理您的请求时出现了错误。",history:r.history||[]}};e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(t)}

`)),e.close()}}});return new Response(n,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type"}})}catch(e){return console.error("QAnything Stream API Error:",e),new Response(JSON.stringify({success:!1,error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}})}}let l=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/qanything/stream/route",pathname:"/api/qanything/stream",filename:"route",bundlePath:"app/api/qanything/stream/route"},resolvedPagePath:"C:\\Users\\24247\\Desktop\\新建文件夹\\新建文件夹\\src\\app\\api\\qanything\\stream\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:c,workUnitAsyncStorage:u,serverHooks:h}=l;function p(){return(0,i.patchFetch)({workAsyncStorage:c,workUnitAsyncStorage:u})}},6487:()=>{},6559:(e,r,t)=>{"use strict";e.exports=t(4870)},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[719],()=>t(4967));module.exports=o})();