(()=>{var e={};e.id=314,e.ids=[314],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1831:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>c,serverHooks:()=>p,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>u});var o={};r.r(o),r.d(o,{POST:()=>d});var n=r(6559),s=r(8088),i=r(7719);async function a(e){try{let t=await fetch("https://openapi.youdao.com/q_anything/api/kb_list",{method:"GET",headers:{Authorization:e}});if(t.ok){let e=await t.json();if(0==e.errorCode&&e.result&&e.result.length>0){let t=e.result[0].kbId;return console.log("Using existing knowledge base:",t),t}}console.log("Creating new knowledge base...");let r=await fetch("https://openapi.youdao.com/q_anything/api/create_kb",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({kbName:"Course Showcase AI助手"})});if(!r.ok){let e=await r.text();throw Error(`Failed to create knowledge base: ${r.status} - ${e}`)}let o=await r.json();if(0!=o.errorCode)throw Error(`Knowledge base creation failed: ${o.msg}`);let n=o.result.kbId;return console.log("Created new knowledge base:",n),console.log("Please add FAQs through QAnything platform to enable Q&A functionality."),n}catch(e){throw console.error("Error managing knowledge base:",e),e}}async function d(e){try{let t=await e.json(),r=process.env.QANYTHING_API_KEY;if(!r)return new Response(JSON.stringify({success:!1,error:"QAnything API Key not configured"}),{status:500,headers:{"Content-Type":"application/json"}});if(!t.question||0===t.question.trim().length)return new Response(JSON.stringify({success:!1,error:"问题不能为空"}),{status:400,headers:{"Content-Type":"application/json"}});let o={question:t.question,kbIds:t.kbIds&&t.kbIds.length>0?t.kbIds:[],prompt:t.prompt||"",history:t.history||[],model:t.model||"QAnything 4o mini",maxToken:t.maxToken||1024,hybridSearch:t.hybridSearch||!1,networking:void 0!==t.networking&&t.networking,sourceNeeded:void 0===t.sourceNeeded||t.sourceNeeded},n=new ReadableStream({async start(e){try{let t=o.kbIds;t&&0!==t.length||(t=[await a(r)]);let n=t.filter(e=>e&&"string"==typeof e&&e.startsWith("KB"));if(0===n.length)throw Error("无效的知识库ID格式");t=n;let s={question:o.question,kbIds:t,prompt:o.prompt||"",history:o.history||[],model:o.model||"QAnything 4o mini",maxToken:o.maxToken||1024,hybridSearch:o.hybridSearch||!1,networking:void 0!==o.networking&&o.networking,sourceNeeded:void 0===o.sourceNeeded||o.sourceNeeded};console.log("QAnything API Direct Request:",JSON.stringify(s,null,2));let i=await fetch("https://openapi.youdao.com/q_anything/api/chat_stream",{method:"POST",headers:{Authorization:r,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){let t=`HTTP ${i.status}: ${i.statusText}`;try{let e=await i.text();if(e){console.error("QAnything API Error Response:",e);try{let r=JSON.parse(e);"303"===r.errorCode||303===r.errorCode?t="QAnything服务器暂时不可用，请稍后重试":"406"===r.errorCode||406===r.errorCode?t="QAnything API参数错误，请检查知识库设置":r.msg&&(t=`QAnything API错误：${r.msg}`)}catch{t+=` - ${e}`}}}catch(e){console.error("Failed to read error response:",e)}let r={errorCode:-1,msg:t,result:{question:s.question,response:`抱歉，${t}`,history:s.history||[]}};e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(r)}

`)),e.close();return}let d=i.body?.getReader();if(!d)throw Error("无法读取响应流");try{for(;;){let{done:t,value:r}=await d.read();if(t)break;e.enqueue(r)}}finally{d.releaseLock()}e.close()}catch(o){console.error("Stream error:",o);let r={errorCode:-1,msg:o instanceof Error?o.message:"Unknown error",result:{question:t.question,response:"抱歉，处理您的请求时出现了错误。",history:t.history||[]}};e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(r)}

`)),e.close()}}});return new Response(n,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type"}})}catch(e){return console.error("QAnything Stream Direct API Error:",e),new Response(JSON.stringify({success:!1,error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}})}}let c=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/qanything/stream-direct/route",pathname:"/api/qanything/stream-direct",filename:"route",bundlePath:"app/api/qanything/stream-direct/route"},resolvedPagePath:"C:\\Users\\24247\\Desktop\\新建文件夹\\新建文件夹\\src\\app\\api\\qanything\\stream-direct\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:l,workUnitAsyncStorage:u,serverHooks:p}=c;function h(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:u})}},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6487:()=>{},6559:(e,t,r)=>{"use strict";e.exports=r(4870)},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[719],()=>r(1831));module.exports=o})();