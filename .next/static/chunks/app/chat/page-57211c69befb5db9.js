(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{1073:(e,t,s)=>{"use strict";s.d(t,{default:()=>i});var r=s(5155),a=s(2115),n=s(9434),l=s(1950);function o(e){let{onSettingsChange:t,className:s=""}=e,[n,o]=(0,a.useState)(!1),[i,c]=(0,a.useState)({model:"QAnything 4o mini",maxToken:1024,hybridSearch:!1,networking:!1,sourceNeeded:!0,kbIds:[]}),[d,u]=(0,a.useState)([]),[m,x]=(0,a.useState)(!1),h=(0,a.useCallback)(async()=>{x(!0);try{let e=await fetch("/api/qanything/kb-list");if(e.ok){let t=await e.json();if(t.success&&t.knowledgeBases){u(t.knowledgeBases);let e=t.knowledgeBases.find(e=>1===e.status);e&&0===i.kbIds.length&&(console.log("Auto-selecting ready knowledge base:",e.kbId,e.kbName),c(t=>({...t,kbIds:[e.kbId]})))}}}catch(e){console.error("Failed to fetch knowledge bases:",e)}finally{x(!1)}},[i.kbIds]);(0,a.useEffect)(()=>{h()},[h]),(0,a.useEffect)(()=>{t(i)},[i,t]);let g=(e,t)=>{c(s=>({...s,[e]:t}))},p=e=>{c(t=>({...t,kbIds:t.kbIds.includes(e)?t.kbIds.filter(t=>t!==e):[...t.kbIds,e]}))};return(0,r.jsxs)("div",{className:"relative ".concat(s),children:[(0,r.jsx)("button",{onClick:()=>o(!n),className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors",title:"聊天设置",children:(0,r.jsxs)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}),n&&(0,r.jsx)("div",{className:"absolute right-0 top-full mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50",children:(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"聊天设置"}),(0,r.jsx)("button",{onClick:()=>o(!1),className:"text-gray-400 hover:text-gray-600",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"AI 模型"}),(0,r.jsx)("select",{value:i.model,onChange:e=>g("model",e.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:Object.entries(l.bJ).map(e=>{let[t,s]=e;return(0,r.jsxs)("option",{value:s.name,children:[s.name," - ",s.description]},t)})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["最大Token数: ",i.maxToken]}),(0,r.jsx)("input",{type:"range",min:"512",max:"4096",step:"256",value:i.maxToken,onChange:e=>g("maxToken",parseInt(e.target.value)),className:"w-full"}),(0,r.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[(0,r.jsx)("span",{children:"512"}),(0,r.jsx)("span",{children:"4096"})]})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"混合搜索"}),(0,r.jsx)("input",{type:"checkbox",checked:i.hybridSearch,onChange:e=>g("hybridSearch",e.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"联网搜索"}),(0,r.jsx)("input",{type:"checkbox",checked:i.networking,onChange:e=>g("networking",e.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"显示信息源"}),(0,r.jsx)("input",{type:"checkbox",checked:i.sourceNeeded,onChange:e=>g("sourceNeeded",e.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"知识库选择"}),(0,r.jsx)("button",{onClick:h,disabled:m,className:"text-xs text-blue-600 hover:text-blue-800 disabled:opacity-50",children:m?"刷新中...":"刷新"})]}),d.length>0?(0,r.jsx)("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:d.map(e=>(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("input",{type:"checkbox",id:e.kbId,checked:i.kbIds.includes(e.kbId),onChange:()=>p(e.kbId),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),(0,r.jsx)("label",{htmlFor:e.kbId,className:"text-sm text-gray-700 flex-1",children:e.kbName}),(0,r.jsx)("span",{className:"text-xs px-2 py-1 rounded ".concat(1===e.status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:1===e.status?"就绪":"处理中"})]},e.kbId))}):(0,r.jsx)("p",{className:"text-sm text-gray-500",children:m?"加载中...":"暂无知识库"})]}),(0,r.jsx)("div",{className:"pt-3 border-t border-gray-200",children:(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["当前配置: ",i.model,", ",i.maxToken," tokens",i.kbIds.length>0&&", ".concat(i.kbIds.length," 个知识库")]})})]})]})})]})}function i(e){let{className:t=""}=e,[s,l]=(0,a.useState)([]),[i,c]=(0,a.useState)(""),[d,u]=(0,a.useState)("idle"),[m,x]=(0,a.useState)(null),[h,g]=(0,a.useState)({model:"QAnything 4o mini",maxToken:1024,hybridSearch:!1,networking:!1,sourceNeeded:!0,kbIds:[]}),[p,b]=(0,a.useState)(!0),f=(0,a.useRef)(null),y=(0,a.useRef)({accumulatedResponse:"",assistantMessageId:"",isComplete:!1}),k=(0,a.useCallback)(e=>{g(e)},[]),j=(0,a.useCallback)((e,t,s)=>{l(r=>r.map(r=>r.id===e?{...r,content:t,sources:s}:r))},[]),N=async()=>{if(!i.trim()||"loading"===d)return;let e={id:(0,n.$C)(),type:"user",content:i.trim(),timestamp:new Date};l(t=>[...t,e]),c(""),u("loading"),x(null);let t={id:(0,n.$C)(),type:"assistant",content:"",timestamp:new Date};l(e=>[...e,t]),y.current={accumulatedResponse:"",assistantMessageId:t.id,isComplete:!1};try{var r,a;let n=[];for(let e=0;e<s.length;e++){let t=s[e];if("user"===t.type)for(let r=e+1;r<s.length;r++){let e=s[r];if("assistant"===e.type&&e.content.trim().length>0){n.push({question:t.content,response:e.content});break}}}let o=n.slice(-2);if(0===h.kbIds.length){l(e=>e.map(e=>e.id===t.id?{...e,content:"请先在设置中选择一个知识库，然后再提问。点击右上角的设置按钮选择知识库。"}:e)),u("error");return}let i={question:e.content,kbIds:h.kbIds,history:o,model:h.model,maxToken:h.maxToken,hybridSearch:h.hybridSearch,networking:h.networking,sourceNeeded:h.sourceNeeded},c=await fetch(p?"/api/qanything/stream-direct":"/api/qanything/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!c.ok)throw Error("HTTP ".concat(c.status,": ").concat(c.statusText));let d=null==(r=c.body)?void 0:r.getReader();if(!d)throw Error("无法读取响应流");let m=new TextDecoder,g="";try{for(;;){let{done:e,value:t}=await d.read();if(e)break;let s=(g+=m.decode(t,{stream:!0})).split("\n");for(let e of(g=s.pop()||"",s))if(e.startsWith("data:"))try{let t=e.slice(5).trim();if(!t)continue;let s=JSON.parse(t),r=parseInt(s.errorCode,10);if(0===r&&s.result){if(s.result.question&&s.result.history&&s.result.source){console.log("Skipping final chunk to avoid duplication");continue}s.result.response&&(y.current.accumulatedResponse+=s.result.response,j(y.current.assistantMessageId,y.current.accumulatedResponse,s.result.source))}else if(0!==r){let e=(null==(a=s.result)?void 0:a.response)||s.msg||"QAnything API error";j(y.current.assistantMessageId,e),x(s.msg||"QAnything API error"),u("error");return}}catch(t){console.warn("Failed to parse SSE data:",e,t)}}}finally{d.releaseLock()}y.current.accumulatedResponse||l(e=>e.map(e=>e.id===t.id?{...e,content:"抱歉，我没有找到相关的回答。请尝试重新表述您的问题或检查知识库设置。"}:e)),u("success")}catch(s){console.error("Chat error:",s);let e=s instanceof Error?s.message:"发生未知错误";x(e),l(s=>s.map(s=>s.id===t.id?{...s,content:"抱歉，处理您的请求时出现了错误：".concat(e)}:s)),u("error")}};return(0,r.jsxs)("div",{className:"flex flex-col h-full bg-white rounded-lg shadow-lg ".concat(t),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:(0,r.jsx)("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"AI 问答助手"}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"基于 QAnything 大语言模型"})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)(o,{onSettingsChange:k}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:p?"直接模式":"代理模式"}),(0,r.jsx)("button",{onClick:()=>b(!p),className:"relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ".concat(p?"bg-blue-600":"bg-gray-200"),title:p?"当前：直接模式（最佳性能）":"当前：代理模式（可能有延迟）",children:(0,r.jsx)("span",{className:"inline-block h-3 w-3 transform rounded-full bg-white transition-transform ".concat(p?"translate-x-5":"translate-x-1")})})]}),(0,r.jsx)("button",{onClick:()=>{l([]),x(null),u("idle")},className:"px-3 py-1 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors",children:"清空对话"})]})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[0===s.length?(0,r.jsxs)("div",{className:"text-center text-gray-500 py-8",children:[(0,r.jsx)("svg",{className:"w-12 h-12 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("p",{children:"开始与 AI 助手对话吧！"}),(0,r.jsx)("p",{className:"text-sm mt-1",children:"您可以询问任何问题，我会尽力为您解答。"})]}):s.map(e=>(0,r.jsx)("div",{className:"flex ".concat("user"===e.type?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-[80%] rounded-lg px-4 py-2 ".concat("user"===e.type?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[(0,r.jsx)("div",{className:"whitespace-pre-wrap",children:e.content}),e.sources&&e.sources.length>0&&(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[(0,r.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"信息来源："}),e.sources.map((e,t)=>(0,r.jsxs)("div",{className:"text-xs text-gray-600 mb-1",children:[(0,r.jsx)("span",{className:"font-medium",children:e.fileName}),(0,r.jsxs)("span",{className:"ml-2 text-gray-400",children:["置信度: ",parseFloat(e.score).toFixed(2)]})]},t))]})]})},e.id)),"loading"===d&&(0,r.jsx)("div",{className:"flex justify-start",children:(0,r.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-2",children:(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),(0,r.jsx)("span",{className:"text-gray-600",children:"AI 正在思考..."})]})})})]}),m&&(0,r.jsx)("div",{className:"mx-4 mb-2 p-3 bg-red-50 border border-red-200 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-center space-x-2 text-red-700",children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,r.jsx)("span",{className:"text-sm",children:m})]})}),(0,r.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)("textarea",{ref:f,value:i,onChange:e=>c(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),N())},placeholder:"输入您的问题...",className:"flex-1 resize-none border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:1,disabled:"loading"===d}),(0,r.jsx)("button",{onClick:N,disabled:!i.trim()||"loading"===d,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]})}},1950:(e,t,s)=>{"use strict";s.d(t,{Sn:()=>r,bJ:()=>a,iu:()=>n});let r={WAKATIME:{BASE_URL:"https://api.wakatime.com/api/v1",ALL_TIME:"/users/current/all_time_since_today",STATS:"/users/current/stats",SUMMARIES:"/users/current/summaries",STATUS_BAR:"/users/current/status_bar/today"},QANYTHING:{BASE_URL:s(9509).env.QANYTHING_API_BASE_URL||"https://openapi.youdao.com/q_anything/api",CHAT_STREAM:"/chat_stream",BOT_CHAT_STREAM:"/bot/chat_stream"}},a={"QAnything 4o mini":{name:"QAnything 4o mini",maxToken:{min:512,max:1024,default:512},description:"轻量级模型，响应速度快"},"QAnything 4o":{name:"QAnything 4o",maxToken:{min:1024,max:4096,default:1024},description:"标准模型，平衡性能与质量"},"deepseek-pro":{name:"deepseek-pro",maxToken:{min:1024,max:4096,default:1024},description:"专业模型，高质量回答"},"deepseek-lite":{name:"deepseek-lite",maxToken:{min:1024,max:4096,default:1024},description:"轻量级专业模型"},"deepseek-chat":{name:"deepseek-chat",maxToken:{min:1024,max:4096,default:1024},description:"对话优化模型"}},n={HTML:{name:"HTML",color:"#E34F26",description:"HTML基础练习"},CSS:{name:"CSS",color:"#1572B6",description:"CSS样式练习"},JAVASCRIPT:{name:"JavaScript",color:"#F7DF1E",description:"JavaScript编程练习"},REACT:{name:"React",color:"#61DAFB",description:"React框架练习"},NEXTJS:{name:"Next.js",color:"#000000",description:"Next.js全栈练习"},PROJECT:{name:"综合项目",color:"#8B5CF6",description:"综合性项目练习"}}},3832:(e,t,s)=>{Promise.resolve().then(s.bind(s,1073))},9434:(e,t,s)=>{"use strict";s.d(t,{$C:()=>i,cn:()=>n,fU:()=>l,fw:()=>o});var r=s(2596),a=s(9688);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,a.QP)((0,r.$)(t))}function l(e){if(e<60)return"".concat(Math.round(e),"秒");let t=Math.floor(e/60);if(t<60)return"".concat(t,"分钟");let s=Math.floor(t/60),r=t%60;if(s<24)return r>0?"".concat(s,"小时").concat(r,"分钟"):"".concat(s,"小时");let a=Math.floor(s/24),n=s%24;return n>0?"".concat(a,"天").concat(n,"小时"):"".concat(a,"天")}function o(e){let t=new Date,s=new Date(e),r=Math.floor((t.getTime()-s.getTime())/1e3),a=Math.floor(r/60),n=Math.floor(a/60),l=Math.floor(n/24);return r<60?"刚刚":a<60?"".concat(a,"分钟前"):n<24?"".concat(n,"小时前"):l<7?"".concat(l,"天前"):new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}function i(){return Math.random().toString(36).substr(2,9)}}},e=>{var t=t=>e(e.s=t);e.O(0,[277,441,684,358],()=>t(3832)),_N_E=e.O()}]);